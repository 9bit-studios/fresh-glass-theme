{% comment %}
  Direct conversion of your petersen_cart_page.html to Shopify
  This creates the EXACT cart layout you designed
{% endcomment %}

{% layout 'theme' %}

<style>
    /* Your exact CSS from petersen_cart_page.html */
    :root {
        --color-bg: #000000;
        --color-text: #FFFFFF;
        --color-text-secondary: rgba(255,255,255,0.7);
        --color-text-tertiary: rgba(255,255,255,0.5);
        --color-primary: #007AFF;
        --color-secondary: #5AC8FA;
        --color-glass: rgba(255,255,255,0.02);
        --color-glass-hover: rgba(255,255,255,0.05);
        --color-border: rgba(255,255,255,0.1);
        --color-success: #34C759;
        --color-warning: #FF9500;
        --color-danger: #FF3B30;
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-2xl: 48px;
        
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 24px;
        
        --transition: 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--color-bg);
        color: var(--color-text);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--spacing-lg);
    }

    /* Breadcrumbs */
    .breadcrumbs {
        padding: var(--spacing-md) 0;
        border-bottom: 1px solid var(--color-border);
    }

    .breadcrumb-nav {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 0.85rem;
        color: var(--color-text-tertiary);
    }

    .breadcrumb-nav a {
        color: var(--color-text-secondary);
        text-decoration: none;
        transition: color var(--transition);
    }

    .breadcrumb-nav a:hover {
        color: var(--color-text);
    }

    .breadcrumb-separator {
        color: var(--color-text-tertiary);
        font-size: 0.75rem;
    }

    /* Cart Page Layout */
    .cart-page {
        padding: var(--spacing-2xl) 0;
        min-height: 60vh;
    }

    .cart-layout {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: var(--spacing-2xl);
        align-items: start;
    }

    .cart-main {
        background: var(--color-glass);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .cart-header {
        padding: var(--spacing-xl);
        border-bottom: 1px solid var(--color-border);
    }

    .cart-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
    }

    .cart-count {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
    }

    .cart-items {
        padding: 0;
    }

    .cart-item {
        display: grid;
        grid-template-columns: 80px 1fr auto auto;
        gap: var(--spacing-md);
        align-items: center;
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        transition: background var(--transition);
    }

    .cart-item:hover {
        background: var(--color-glass-hover);
    }

    .cart-item:last-child {
        border-bottom: none;
    }

    .item-image {
        width: 80px;
        height: 80px;
        background: #111;
        border-radius: var(--radius-sm);
        overflow: hidden;
    }

    .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-details {
        min-width: 0;
    }

    .item-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        line-height: 1.3;
    }

    .item-title a {
        color: var(--color-text);
        text-decoration: none;
    }

    .item-title a:hover {
        color: var(--color-primary);
    }

    .item-variant {
        color: var(--color-text-secondary);
        font-size: 0.85rem;
        margin-bottom: var(--spacing-xs);
    }

    .item-price {
        color: var(--color-text);
        font-weight: 600;
    }

    .item-quantity {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        background: var(--color-glass);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs);
    }

    .qty-btn {
        width: 28px;
        height: 28px;
        background: transparent;
        border: none;
        color: var(--color-text);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: background var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .qty-btn:hover {
        background: var(--color-glass-hover);
    }

    .qty-input {
        width: 40px;
        text-align: center;
        background: transparent;
        border: none;
        color: var(--color-text);
        font-size: 0.9rem;
    }

    .item-remove {
        color: var(--color-text-secondary);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        transition: all var(--transition);
        background: none;
        border: none;
        font-size: 1rem;
    }

    .item-remove:hover {
        color: var(--color-danger);
        background: rgba(255, 59, 48, 0.1);
    }

    /* Cart Summary Sidebar */
    .cart-summary {
        position: sticky;
        top: 120px;
        background: var(--color-glass);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
    }

    .summary-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: var(--spacing-lg);
    }

    .summary-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        font-size: 0.9rem;
    }

    .summary-line.total {
        font-size: 1.125rem;
        font-weight: 700;
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--color-border);
        margin-top: var(--spacing-md);
    }

    .discount-code {
        margin: var(--spacing-lg) 0;
    }

    .discount-form {
        display: flex;
        gap: var(--spacing-sm);
    }

    .discount-input {
        flex: 1;
        padding: 12px;
        background: var(--color-glass);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        color: var(--color-text);
        font-size: 0.9rem;
    }

    .discount-input::placeholder {
        color: var(--color-text-tertiary);
    }

    .btn-apply {
        padding: 12px 20px;
        background: var(--color-glass);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        color: var(--color-text);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-apply:hover {
        background: var(--color-glass-hover);
        border-color: var(--color-primary);
    }

    .btn-checkout {
        width: 100%;
        padding: 16px;
        background: var(--color-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all var(--transition);
        margin-top: var(--spacing-lg);
        text-decoration: none;
        display: block;
        text-align: center;
    }

    .btn-checkout:hover {
        background: #0056CC;
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
    }

    .continue-shopping {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        color: var(--color-text-secondary);
        text-decoration: none;
        margin-top: var(--spacing-lg);
        font-size: 0.9rem;
        transition: color var(--transition);
    }

    .continue-shopping:hover {
        color: var(--color-text);
    }

    /* Empty Cart State */
    .empty-cart {
        text-align: center;
        padding: var(--spacing-2xl);
        background: var(--color-glass);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-lg);
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: var(--spacing-md);
    }

    .empty-text {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-xl);
    }

    .btn-shop {
        display: inline-flex;
        align-items: center;
        padding: 16px 32px;
        background: var(--color-primary);
        color: white;
        text-decoration: none;
        border-radius: var(--radius-lg);
        font-weight: 600;
        transition: all var(--transition);
    }

    .btn-shop:hover {
        background: #0056CC;
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(0, 122, 255, 0.3);
    }

    /* Success Messages */
    .success-message {
        background: rgba(52, 199, 89, 0.1);
        border: 1px solid rgba(52, 199, 89, 0.3);
        color: var(--color-success);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        display: none;
    }

    .success-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .cart-layout {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        .cart-item {
            grid-template-columns: 60px 1fr auto;
            grid-template-rows: auto auto;
            gap: var(--spacing-sm);
        }

        .item-image {
            width: 60px;
            height: 60px;
        }

        .item-quantity {
            grid-column: 1 / -1;
            justify-self: start;
            margin-top: var(--spacing-sm);
        }

        .item-remove {
            grid-row: 1;
            grid-column: 3;
        }
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(-100%);
        }
    }
</style>

<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <nav class="breadcrumb-nav">
            <a href="/">Home</a>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span>Shopping Cart</span>
        </nav>
    </div>
</div>

<!-- Cart Page -->
<section class="cart-page">
    <div class="container">
        <div id="cart-content">
            {% if cart == empty %}
                <!-- Empty Cart State -->
                <div class="empty-cart">
                    <div class="empty-icon">üõí</div>
                    <h2 class="empty-title">Your cart is empty</h2>
                    <p class="empty-text">Looks like you haven't added any games to your cart yet. Start exploring our legendary horror strategy games!</p>
                    <a href="{{ routes.all_products_collection_url }}" class="btn-shop">Start Shopping</a>
                </div>
            {% else %}
                <!-- Cart with Items -->
                <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-form">
                    <div class="cart-layout">
                        <!-- Cart Items -->
                        <div class="cart-main">
                            <div class="cart-header">
                                <h1 class="cart-title">Shopping Cart</h1>
                                <p class="cart-count">{{ cart.item_count }} {% if cart.item_count == 1 %}item{% else %}items{% endif %} in your cart</p>
                            </div>

                            <div class="success-message" id="success-message">
                                ‚úì Cart updated successfully
                            </div>

                            <div class="cart-items" id="cart-items">
                                {% for item in cart.items %}
                                    <div class="cart-item" data-line-item-key="{{ item.key }}">
                                        <div class="item-image">
                                            {% if item.image %}
                                                <img src="{{ item.image | image_url: width: 160 }}" 
                                                     alt="{{ item.image.alt | escape }}">
                                            {% else %}
                                                <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'><rect fill='%23333' width='80' height='80'/><text x='50%' y='50%' text-anchor='middle' dy='0.3em' fill='%23666' font-size='8'>{{ item.product.title | slice: 0, 10 }}</text></svg>" 
                                                     alt="{{ item.product.title }}">
                                            {% endif %}
                                        </div>
                                        <div class="item-details">
                                            <h3 class="item-title">
                                                <a href="{{ item.product.url }}">{{ item.product.title }}</a>
                                            </h3>
                                            {% unless item.product.has_only_default_variant %}
                                                <p class="item-variant">{{ item.variant.title }}</p>
                                            {% endunless %}
                                            {% if item.vendor != blank %}
                                                <p class="item-vendor">{{ item.vendor }}</p>
                                            {% endif %}
                                            <p class="item-price">{{ item.final_price | money }}</p>
                                            {% if item.original_price != item.final_price %}
                                                <p class="item-original-price">{{ item.original_price | money }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="item-quantity">
                                            <button type="button" 
                                                    class="qty-btn" 
                                                    onclick="updateQuantity('{{ item.key }}', {{ item.quantity | minus: 1 }})">‚àí</button>
                                            <input type="number" 
                                                   value="{{ item.quantity }}" 
                                                   min="0" 
                                                   class="qty-input"
                                                   data-line-item-key="{{ item.key }}"
                                                   onchange="updateQuantity('{{ item.key }}', this.value)">
                                            <button type="button" 
                                                    class="qty-btn" 
                                                    onclick="updateQuantity('{{ item.key }}', {{ item.quantity | plus: 1 }})">+</button>
                                        </div>
                                        <button type="button" 
                                                class="item-remove" 
                                                onclick="removeItem('{{ item.key }}')">üóëÔ∏è</button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Cart Summary -->
                        <div class="cart-summary">
                            <h3 class="summary-title">Order Summary</h3>
                            
                            <div class="summary-line">
                                <span>Subtotal</span>
                                <span id="subtotal">{{ cart.total_price | money }}</span>
                            </div>
                            
                            {% if cart.total_discounts > 0 %}
                                <div class="summary-line">
                                    <span>Discounts</span>
                                    <span id="discounts">-{{ cart.total_discounts | money }}</span>
                                </div>
                            {% endif %}
                            
                            <div class="summary-line">
                                <span>Shipping</span>
                                <span id="shipping">Calculated at checkout</span>
                            </div>
                            
                            <div class="summary-line">
                                <span>Tax</span>
                                <span id="tax">Calculated at checkout</span>
                            </div>
                            
                            <div class="summary-line total">
                                <span>Total</span>
                                <span id="total">{{ cart.total_price | money }}</span>
                            </div>

                            <!-- Discount Code -->
                            <div class="discount-code">
                                <div class="discount-form">
                                    <input type="text" 
                                           placeholder="Discount code" 
                                           class="discount-input" 
                                           id="discount-input">
                                    <button type="button" 
                                            class="btn-apply"
                                            onclick="applyDiscount()">Apply</button>
                                </div>
                            </div>

                            <!-- Checkout Button -->
                            <a href="/checkout" class="btn-checkout">
                                Proceed to Checkout
                            </a>

                            <a href="{{ routes.all_products_collection_url }}" class="continue-shopping">
                                ‚Üê Continue Shopping
                            </a>
                        </div>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>
</section>

<script>
    // Cart functionality
    function updateQuantity(lineItemKey, newQuantity) {
        newQuantity = parseInt(newQuantity);
        if (newQuantity < 0) newQuantity = 0;

        showSuccessMessage();

        // Update cart via AJAX
        fetch('/cart/change.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: lineItemKey,
                quantity: newQuantity
            })
        })
        .then(response => response.json())
        .then(cart => {
            if (newQuantity === 0) {
                // Remove item from DOM
                const itemElement = document.querySelector(`[data-line-item-key="${lineItemKey}"]`);
                itemElement.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    itemElement.remove();
                    if (cart.item_count === 0) {
                        window.location.reload(); // Reload to show empty cart
                    }
                }, 300);
            } else {
                // Update the input field
                const input = document.querySelector(`[data-line-item-key="${lineItemKey}"] .qty-input`);
                input.value = newQuantity;
            }

            // Update cart totals
            updateCartTotals(cart);
            updateCartCount(cart.item_count);
        })
        .catch(error => {
            console.error('Error updating cart:', error);
        });
    }

    function removeItem(lineItemKey) {
        updateQuantity(lineItemKey, 0);
    }

    function updateCartTotals(cart) {
        const subtotalElement = document.getElementById('subtotal');
        const totalElement = document.getElementById('total');
        
        if (subtotalElement) {
            subtotalElement.textContent = formatMoney(cart.total_price);
        }
        
        if (totalElement) {
            totalElement.textContent = formatMoney(cart.total_price);
        }

        // Update cart count in header if it exists
        const cartCountElement = document.querySelector('.cart-count');
        if (cartCountElement) {
            cartCountElement.textContent = `${cart.item_count} ${cart.item_count === 1 ? 'item' : 'items'} in your cart`;
        }
    }

    function updateCartCount(itemCount) {
        // Update any cart count indicators in the header
        const cartCountIndicators = document.querySelectorAll('.cart-icon span, [data-cart-count]');
        cartCountIndicators.forEach(indicator => {
            indicator.textContent = itemCount;
        });
    }

    function showSuccessMessage() {
        const message = document.getElementById('success-message');
        if (message) {
            message.classList.add('show');
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }
    }

    function applyDiscount() {
        const discountCode = document.getElementById('discount-input').value.trim();
        const btn = document.querySelector('.btn-apply');
        
        if (!discountCode) return;

        // Apply discount via AJAX
        fetch('/discount/' + encodeURIComponent(discountCode), {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                btn.textContent = 'Applied!';
                btn.style.background = 'var(--color-success)';
                btn.style.borderColor = 'var(--color-success)';
                showSuccessMessage();
                
                // Refresh page to show updated cart
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                btn.textContent = 'Invalid';
                btn.style.background = 'var(--color-danger)';
                btn.style.borderColor = 'var(--color-danger)';
            }
            
            setTimeout(() => {
                btn.textContent = 'Apply';
                btn.style.background = '';
                btn.style.borderColor = '';
            }, 2000);
        })
        .catch(error => {
            console.error('Error applying discount:', error);
            btn.textContent = 'Error';
            btn.style.background = 'var(--color-danger)';
            
            setTimeout(() => {
                btn.textContent = 'Apply';
                btn.style.background = '';
            }, 2000);
        });
    }

    // Utility function to format money (basic version)
    function formatMoney(cents) {
        return (cents / 100).toLocaleString('en-US', {
            style: 'currency',
            currency: '{{ cart.currency.iso_code }}'
        });
    }

    // Handle quantity input changes
    document.querySelectorAll('.qty-input').forEach(input => {
        input.addEventListener('change', function() {
            const lineItemKey = this.dataset.lineItemKey;
            const newQuantity = parseInt(this.value);
            updateQuantity(lineItemKey, newQuantity);
        });
    });
</script>