{%- comment -%}
  Petersen Games Enhanced Product Page Template
  Custom product page with metafields integration and tabbed component

  Features:
  - Brand-aware hero section
  - Metafields integration for game information
  - Elegant tabbed content display
  - Apple HIG compliant layout
  - Horror-gaming aesthetic
{%- endcomment -%}

<div class="petersen-product-page" data-product-id="{{ product.id }}">

  <!-- Product Hero Section -->
  <div class="product-hero">
    <div class="product-media">
      <div class="product-gallery">
        {%- if product.media.size > 0 -%}
          <div class="main-image-container">
            <img
              src="{{ product.featured_media | image_url: width: 800 }}"
              alt="{{ product.featured_media.alt | default: product.title }}"
              class="main-product-image"
              id="main-product-image"
              width="800"
              height="800"
            >
          </div>

          {%- if product.media.size > 1 -%}
          <div class="thumbnail-gallery">
            {%- for media in product.media limit: 6 -%}
              <button
                class="thumbnail-button {% if forloop.first %}active{% endif %}"
                data-media-id="{{ media.id }}"
                type="button"
              >
                <img
                  src="{{ media | image_url: width: 120 }}"
                  alt="{{ media.alt | default: product.title }}"
                  class="thumbnail-image"
                  width="120"
                  height="120"
                >
              </button>
            {%- endfor -%}
          </div>
          {%- endif -%}
        {%- else -%}
          <div class="no-image-placeholder">
            <span class="placeholder-text">{{ product.title }}</span>
          </div>
        {%- endif -%}
      </div>
    </div>

    <div class="product-info">
      <div class="product-header">
        <h1 class="product-title">{{ product.title }}</h1>

        {%- assign theme_info = product.metafields.petersen_games.theme_info.value -%}
        {%- if theme_info.primary_theme -%}
          <div class="product-theme">
            <span class="theme-badge">{{ theme_info.primary_theme }}</span>
            {%- if theme_info.horror_level -%}
            <div class="horror-rating">
              <span class="horror-label">Horror Level:</span>
              <div class="horror-skulls">
                {%- for i in (1..5) -%}
                  <span class="skull {% if i <= theme_info.horror_level %}active{% endif %}">üíÄ</span>
                {%- endfor -%}
              </div>
            </div>
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- assign awards = product.metafields.petersen_games.awards.value -%}
        {%- if awards.awards -%}
          <div class="product-awards">
            {%- for award in awards.awards limit: 3 -%}
              <div class="award-badge">
                <span class="award-icon">üèÜ</span>
                <span class="award-text">{{ award.name }} {{ award.year }}</span>
              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>

      <div class="product-pricing">
        <div class="price-container">
          {%- if product.compare_at_price > product.price -%}
            <span class="price-sale">{{ product.price | money }}</span>
            <span class="price-original">{{ product.compare_at_price | money }}</span>
            <span class="sale-badge">{{ product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price }}% OFF</span>
          {%- else -%}
            <span class="price-regular">{{ product.price | money }}</span>
          {%- endif -%}
        </div>

        {%- if product.metafields.petersen_games.shipping.value.shipping_class -%}
          <div class="shipping-info">
            <span class="shipping-icon">üöö</span>
            <span class="shipping-text">
              {%- case product.metafields.petersen_games.shipping.value.shipping_class -%}
                {%- when 'Standard' -%}
                  Free shipping on orders over $99
                {%- when 'Oversized' -%}
                  Oversized item - Special shipping rates apply
                {%- when 'Heavy' -%}
                  Heavy item - Freight shipping required
                {%- else -%}
                  Standard shipping available
              {%- endcase -%}
            </span>
          </div>
        {%- endif -%}
      </div>

      {%- assign game_stats = product.metafields.petersen_games.game_stats.value -%}
      {%- if game_stats -%}
      <div class="quick-stats-hero">
        <div class="stats-grid-hero">
          {%- if game_stats.player_count -%}
          <div class="stat-item-hero">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
              <span class="stat-label">Players</span>
              <span class="stat-value">
                {%- if game_stats.player_count.min == game_stats.player_count.max -%}
                  {{ game_stats.player_count.min }}
                {%- else -%}
                  {{ game_stats.player_count.min }}-{{ game_stats.player_count.max }}
                {%- endif -%}
              </span>
            </div>
          </div>
          {%- endif -%}

          {%- if game_stats.play_time -%}
          <div class="stat-item-hero">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-content">
              <span class="stat-label">Time</span>
              <span class="stat-value">
                {%- if game_stats.play_time.min == game_stats.play_time.max -%}
                  {{ game_stats.play_time.min }}min
                {%- else -%}
                  {{ game_stats.play_time.min }}-{{ game_stats.play_time.max }}min
                {%- endif -%}
              </span>
            </div>
          </div>
          {%- endif -%}

          {%- if game_stats.age_range -%}
          <div class="stat-item-hero">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
              <span class="stat-label">Age</span>
              <span class="stat-value">{{ game_stats.age_range.min }}+</span>
            </div>
          </div>
          {%- endif -%}

          {%- if game_stats.complexity -%}
          <div class="stat-item-hero">
            <div class="stat-icon">üß†</div>
            <div class="stat-content">
              <span class="stat-label">Complexity</span>
              <span class="stat-value">{{ game_stats.complexity }}/5</span>
            </div>
          </div>
          {%- endif -%}
        </div>
      </div>
      {%- endif -%}

      <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form">
        <div class="product-variants">
          {%- unless product.has_only_default_variant -%}
            {%- for option in product.options_with_values -%}
              <div class="variant-option">
                <label for="option{{ forloop.index }}" class="variant-label">
                  {{ option.name }}
                </label>
                <select
                  id="option{{ forloop.index }}"
                  name="id"
                  class="variant-select"
                >
                  {%- for value in option.values -%}
                    <option
                      value="{{ value | escape }}"
                      {% if option.selected_value == value %}selected="selected"{% endif %}
                    >
                      {{ value }}
                    </option>
                  {%- endfor -%}
                </select>
              </div>
            {%- endfor -%}
          {%- endunless -%}
        </div>

        <div class="product-actions">
          <div class="quantity-container">
            <label for="quantity" class="quantity-label">Quantity:</label>
            <div class="quantity-input-wrapper">
              <button type="button" class="quantity-button quantity-minus" aria-label="Decrease quantity">-</button>
              <input
                type="number"
                id="quantity"
                name="quantity"
                value="1"
                min="1"
                class="quantity-input"
              >
              <button type="button" class="quantity-button quantity-plus" aria-label="Increase quantity">+</button>
            </div>
          </div>

          <button
            type="submit"
            name="add"
            class="add-to-cart-button"
            {% unless product.available %}disabled{% endunless %}
          >
            <span class="button-text">
              {%- if product.available -%}
                Add to Cart - {{ product.price | money }}
              {%- else -%}
                Sold Out
              {%- endif -%}
            </span>
          </button>
        </div>

        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
      </form>

      <div class="product-guarantees">
        <div class="guarantee-item">
          <span class="guarantee-icon">‚úÖ</span>
          <span class="guarantee-text">30-day satisfaction guarantee</span>
        </div>
        <div class="guarantee-item">
          <span class="guarantee-icon">üîí</span>
          <span class="guarantee-text">Secure checkout</span>
        </div>
        <div class="guarantee-item">
          <span class="guarantee-icon">üì¶</span>
          <span class="guarantee-text">Component replacement guarantee</span>
        </div>
      </div>

      {%- if settings.social_sharing_products -%}
      <div class="product-share">
        <span class="share-label">Share:</span>
        <div class="share-buttons">
          <a
            href="https://www.facebook.com/sharer.php?u={{ shop.url }}{{ product.url }}"
            target="_blank"
            rel="noopener"
            class="share-button facebook"
            aria-label="Share on Facebook"
          >
            üìò
          </a>
          <a
            href="https://twitter.com/intent/tweet?url={{ shop.url }}{{ product.url }}&text={{ product.title | url_encode }}"
            target="_blank"
            rel="noopener"
            class="share-button twitter"
            aria-label="Share on Twitter"
          >
            üê¶
          </a>
          <a
            href="https://www.pinterest.com/pin/create/button/?url={{ shop.url }}{{ product.url }}&media={{ product.featured_media | image_url: width: 600 }}&description={{ product.title | url_encode }}"
            target="_blank"
            rel="noopener"
            class="share-button pinterest"
            aria-label="Share on Pinterest"
          >
            üìå
          </a>
        </div>
      </div>
      {%- endif -%}
    </div>
  </div>

  <!-- Product Information Tabs -->
  <div class="product-tabs-section">
    {% render 'petersen-product-tabs', product: product %}
  </div>

  <!-- Related Products Section -->
  {%- if collections[product.type].products.size > 1 -%}
  <div class="related-products-section">
    <h2 class="related-products-title">More {{ product.type }} Games</h2>
    <div class="related-products-grid">
      {%- assign related_products = collections[product.type].products | where: 'available' -%}
      {%- for related_product in related_products limit: 4 -%}
        {%- unless related_product.id == product.id -%}
          <div class="related-product-item">
            <a href="{{ related_product.url }}" class="related-product-link">
              <div class="related-product-image">
                <img
                  src="{{ related_product.featured_media | image_url: width: 300 }}"
                  alt="{{ related_product.featured_media.alt | default: related_product.title }}"
                  loading="lazy"
                  width="300"
                  height="300"
                >
              </div>
              <div class="related-product-info">
                <h3 class="related-product-title">{{ related_product.title }}</h3>
                <div class="related-product-price">{{ related_product.price | money }}</div>
              </div>
            </a>
          </div>
        {%- endunless -%}
      {%- endfor -%}
    </div>
  </div>
  {%- endif -%}

  <!-- Newsletter Signup for Game Updates -->
  <div class="product-newsletter">
    <div class="newsletter-content">
      <h3>Join the Cosmic Horror Community</h3>
      <p>Get exclusive updates, strategy guides, and early access to new releases.</p>
      <form action="#" method="post" class="newsletter-form">
        <div class="newsletter-input-group">
          <input
            type="email"
            name="email"
            placeholder="Your email address"
            class="newsletter-input"
            required
          >
          <button type="submit" class="newsletter-button">
            Subscribe
          </button>
        </div>
      </form>
    </div>
  </div>

</div>

<!-- Schema Markup for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.title | escape }}",
  "description": "{{ product.description | strip_html | truncate: 160 | escape }}",
  "image": [
    {%- for media in product.media -%}
      "{{ media | image_url: width: 800 }}"{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "brand": {
    "@type": "Brand",
    "name": "Petersen Games"
  },
  "manufacturer": {
    "@type": "Organization",
    "name": "Petersen Games"
  },
  "offers": {
    "@type": "Offer",
    "url": "{{ shop.url }}{{ product.url }}",
    "priceCurrency": "{{ cart.currency.iso_code }}",
    "price": "{{ product.price | divided_by: 100.0 }}",
    "priceValidUntil": "{{ 'now' | date: '%Y' | plus: 1 }}-12-31",
    "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
    "seller": {
      "@type": "Organization",
      "name": "{{ shop.name }}"
    }
  }
  {%- assign game_stats = product.metafields.petersen_games.game_stats.value -%}
  {%- if game_stats -%}
  ,"additionalProperty": [
    {%- if game_stats.player_count -%}
    {
      "@type": "PropertyValue",
      "name": "Number of Players",
      "value": "{%- if game_stats.player_count.min == game_stats.player_count.max -%}{{ game_stats.player_count.min }}{%- else -%}{{ game_stats.player_count.min }}-{{ game_stats.player_count.max }}{%- endif -%}"
    },
    {%- endif -%}
    {%- if game_stats.play_time -%}
    {
      "@type": "PropertyValue",
      "name": "Playing Time",
      "value": "{%- if game_stats.play_time.min == game_stats.play_time.max -%}{{ game_stats.play_time.min }}{%- else -%}{{ game_stats.play_time.min }}-{{ game_stats.play_time.max }}{%- endif -%} minutes"
    },
    {%- endif -%}
    {%- if game_stats.age_range -%}
    {
      "@type": "PropertyValue",
      "name": "Minimum Age",
      "value": "{{ game_stats.age_range.min }}+"
    }
    {%- endif -%}
  ]
  {%- endif -%}
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Image gallery functionality
  const thumbnails = document.querySelectorAll('.thumbnail-button');
  const mainImage = document.getElementById('main-product-image');

  thumbnails.forEach(thumbnail => {
    thumbnail.addEventListener('click', function() {
      // Remove active class from all thumbnails
      thumbnails.forEach(t => t.classList.remove('active'));
      // Add active class to clicked thumbnail
      this.classList.add('active');

      // Update main image
      const newImageSrc = this.querySelector('img').src.replace('width=120', 'width=800');
      const newImageAlt = this.querySelector('img').alt;

      mainImage.src = newImageSrc;
      mainImage.alt = newImageAlt;
    });
  });

  // Quantity controls
  const quantityInput = document.querySelector('.quantity-input');
  const quantityMinus = document.querySelector('.quantity-minus');
  const quantityPlus = document.querySelector('.quantity-plus');

  if (quantityMinus && quantityPlus && quantityInput) {
    quantityMinus.addEventListener('click', function() {
      const currentValue = parseInt(quantityInput.value);
      if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
      }
    });

    quantityPlus.addEventListener('click', function() {
      const currentValue = parseInt(quantityInput.value);
      quantityInput.value = currentValue + 1;
    });
  }

  // Variant selection
  const variantSelects = document.querySelectorAll('.variant-select');
  variantSelects.forEach(select => {
    select.addEventListener('change', function() {
      // Update hidden input with selected variant ID
      // This would typically involve more complex variant logic
      console.log('Variant changed:', this.value);
    });
  });
});
</script>